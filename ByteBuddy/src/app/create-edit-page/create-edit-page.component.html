<app-page>
    <div class="container max-w-4xl py-8">
        <!-- Loading State -->
        <div *ngIf="isLoading" class="flex justify-center py-20">
            <div class="loader"></div>
        </div>

        <!-- Main Content -->
        <div *ngIf="!isLoading">
            <!-- Header -->
            <div class="text-center mb-8">
                <h1 class="text-3xl lg:text-4xl font-bold text-foreground mb-4">
                    {{ getTitle() }}
                </h1>
                <p class="text-lg text-muted-foreground max-w-2xl mx-auto">
                    {{
                        isEditMode
                            ? 'Update your page content and make it even better.'
                            : 'Share your knowledge, tutorials, or insights with the community.'
                    }}
                </p>
            </div>

            <!-- Error Display -->
            <div *ngIf="error" class="card mb-6 border-error-300">
                <div class="card-content text-error-600">
                    {{ error }}
                </div>
            </div>

            <!-- Form -->
            <div class="card">
                <form
                    [formGroup]="pageForm"
                    (ngSubmit)="onSubmit()"
                    class="space-y-6"
                >
                    <div class="card-content space-y-6">
                        <!-- Title Field -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label
                                    for="title"
                                    class="text-sm font-medium text-foreground"
                                >
                                    Page Title
                                    <span class="text-error-500">*</span>
                                </label>
                                <span class="text-xs text-muted-foreground">
                                    {{ getTitleCharCount() }}/200
                                </span>
                            </div>

                            <input
                                id="title"
                                type="text"
                                formControlName="title"
                                placeholder="Enter a descriptive title for your page..."
                                class="input"
                                [class.border-error-300]="
                                    isFieldInvalid('title')
                                "
                                [class.focus:border-error-500]="
                                    isFieldInvalid('title')
                                "
                                [class.focus:ring-error-500]="
                                    isFieldInvalid('title')
                                "
                            />

                            <div
                                *ngIf="isFieldInvalid('title')"
                                class="text-sm text-error-600"
                            >
                                {{ getFieldError('title') }}
                            </div>

                            <p class="text-xs text-muted-foreground">
                                Choose a clear, descriptive title that tells
                                others what your page is about.
                            </p>
                        </div>

                        <!-- Description Field -->
                        <div class="space-y-2">
                            <div class="flex items-center justify-between">
                                <label
                                    for="description"
                                    class="text-sm font-medium text-foreground"
                                >
                                    Description
                                </label>
                                <span class="text-xs text-muted-foreground">
                                    {{ getDescriptionCharCount() }}/1000
                                </span>
                            </div>

                            <textarea
                                id="description"
                                formControlName="description"
                                rows="8"
                                placeholder="Provide a detailed description of your page content. What will readers learn? What topics do you cover?"
                                class="input resize-y"
                                [class.border-error-300]="
                                    isFieldInvalid('description')
                                "
                                [class.focus:border-error-500]="
                                    isFieldInvalid('description')
                                "
                                [class.focus:ring-error-500]="
                                    isFieldInvalid('description')
                                "
                            ></textarea>

                            <div
                                *ngIf="isFieldInvalid('description')"
                                class="text-sm text-error-600"
                            >
                                {{ getFieldError('description') }}
                            </div>

                            <p class="text-xs text-muted-foreground">
                                A good description helps others understand what
                                your page is about and encourages engagement.
                            </p>
                        </div>

                        <!-- Image Upload Section -->
                        <div class="space-y-4">
                            <div class="flex items-center justify-between">
                                <label
                                    class="text-sm font-medium text-foreground"
                                >
                                    Page Image
                                </label>
                                <span class="text-xs text-muted-foreground">
                                    Max {{ maxImageSizeMB }}MB
                                </span>
                            </div>

                            <!-- Current Image Display -->
                            <div *ngIf="hasImageToDisplay()" class="relative">
                                <img
                                    [src]="getImageToDisplay()!"
                                    alt="Page image preview"
                                    class="w-full max-w-sm rounded-lg border border-border object-cover"
                                    style="max-height: 300px"
                                />

                                <!-- Delete Current Image Button -->
                                <button
                                    *ngIf="currentImageUrl && !imagePreview"
                                    type="button"
                                    (click)="deleteImage()"
                                    [disabled]="isDeletingImage"
                                    class="absolute top-2 right-2 bg-error-500 hover:bg-error-600 text-white rounded-full p-2 shadow-lg transition-colors"
                                    title="Delete image"
                                >
                                    <div
                                        *ngIf="isDeletingImage"
                                        class="animate-spin rounded-full h-4 w-4 border-b-2 border-white"
                                    ></div>
                                    <svg
                                        *ngIf="!isDeletingImage"
                                        class="w-4 h-4"
                                        fill="none"
                                        stroke="currentColor"
                                        viewBox="0 0 24 24"
                                    >
                                        <path
                                            stroke-linecap="round"
                                            stroke-linejoin="round"
                                            stroke-width="2"
                                            d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"
                                        ></path>
                                    </svg>
                                </button>
                            </div>

                            <!-- File Input -->
                            <div class="space-y-3">
                                <input
                                    id="imageInput"
                                    type="file"
                                    (change)="onFileSelected($event)"
                                    accept="image/*"
                                    class="hidden"
                                />

                                <div class="flex flex-col sm:flex-row gap-3">
                                    <button
                                        type="button"
                                        (click)="triggerFileInput()"
                                        class="btn-secondary btn-sm flex items-center"
                                        [disabled]="
                                            isUploadingImage || isDeletingImage
                                        "
                                    >
                                        <svg
                                            class="w-4 h-4 mr-2"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z"
                                            ></path>
                                        </svg>
                                        {{
                                            currentImageUrl
                                                ? 'Change Image'
                                                : 'Select Image'
                                        }}
                                    </button>

                                    <!-- Upload Button (for selected file) -->
                                    <button
                                        *ngIf="selectedFile && !isEditMode"
                                        type="button"
                                        (click)="uploadImage()"
                                        [disabled]="isUploadingImage"
                                        class="btn-primary btn-sm flex items-center"
                                    >
                                        <div
                                            *ngIf="isUploadingImage"
                                            class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"
                                        ></div>
                                        <svg
                                            *ngIf="!isUploadingImage"
                                            class="w-4 h-4 mr-2"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                                            ></path>
                                        </svg>
                                        Create Page with Image
                                    </button>

                                    <!-- Upload Button (for edit mode) -->
                                    <button
                                        *ngIf="selectedFile && isEditMode"
                                        type="button"
                                        (click)="uploadImage()"
                                        [disabled]="isUploadingImage"
                                        class="btn-primary btn-sm flex items-center"
                                    >
                                        <div
                                            *ngIf="isUploadingImage"
                                            class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"
                                        ></div>
                                        <svg
                                            *ngIf="!isUploadingImage"
                                            class="w-4 h-4 mr-2"
                                            fill="none"
                                            stroke="currentColor"
                                            viewBox="0 0 24 24"
                                        >
                                            <path
                                                stroke-linecap="round"
                                                stroke-linejoin="round"
                                                stroke-width="2"
                                                d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"
                                            ></path>
                                        </svg>
                                        Upload Image
                                    </button>

                                    <!-- Clear Selection Button -->
                                    <button
                                        *ngIf="selectedFile"
                                        type="button"
                                        (click)="clearImageSelection()"
                                        class="btn-secondary btn-sm"
                                        [disabled]="isUploadingImage"
                                    >
                                        Clear
                                    </button>
                                </div>

                                <!-- Selected File Info -->
                                <div
                                    *ngIf="selectedFile"
                                    class="text-sm text-muted-foreground"
                                >
                                    <p>
                                        Selected: {{ selectedFile.name }} ({{
                                            (
                                                selectedFile.size /
                                                1024 /
                                                1024
                                            ).toFixed(2)
                                        }}MB)
                                    </p>
                                </div>
                            </div>

                            <p class="text-xs text-muted-foreground">
                                Upload an image to make your page more visually
                                appealing. Supported formats:
                                {{ getAllowedImageTypes() }}
                            </p>
                        </div>

                        <!-- Form Guidelines -->
                        <div
                            class="bg-blue-50 border border-blue-200 rounded-lg p-4"
                        >
                            <div class="flex items-start space-x-3">
                                <svg
                                    class="w-5 h-5 text-blue-600 mt-0.5 flex-shrink-0"
                                    fill="none"
                                    stroke="currentColor"
                                    viewBox="0 0 24 24"
                                >
                                    <path
                                        stroke-linecap="round"
                                        stroke-linejoin="round"
                                        stroke-width="2"
                                        d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"
                                    ></path>
                                </svg>
                                <div class="text-sm">
                                    <p class="font-medium text-blue-900 mb-1">
                                        Tips for creating great pages:
                                    </p>
                                    <ul
                                        class="text-blue-800 space-y-1 list-disc list-inside"
                                    >
                                        <li>
                                            Use a clear and descriptive title
                                        </li>
                                        <li>
                                            Write a comprehensive description
                                            that explains the page's purpose
                                        </li>
                                        <li>
                                            Consider your audience and what they
                                            might want to learn
                                        </li>
                                        <li>
                                            Keep your content organized and easy
                                            to follow
                                        </li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="card-content border-t border-border">
                        <div
                            class="flex flex-col sm:flex-row justify-end space-y-2 sm:space-y-0 sm:space-x-3"
                        >
                            <button
                                type="button"
                                (click)="onCancel()"
                                class="btn-secondary btn-md"
                                [disabled]="isSubmitting"
                            >
                                Cancel
                            </button>

                            <button
                                type="submit"
                                class="btn-primary btn-md"
                                [disabled]="pageForm.invalid || isSubmitting"
                            >
                                <div
                                    *ngIf="isSubmitting"
                                    class="flex items-center"
                                >
                                    <div
                                        class="animate-spin rounded-full h-4 w-4 border-b-2 border-white mr-2"
                                    ></div>
                                    {{ getSubmitButtonText() }}
                                </div>
                                <span *ngIf="!isSubmitting">{{
                                    getSubmitButtonText()
                                }}</span>
                            </button>
                        </div>
                    </div>
                </form>
            </div>

            <!-- Preview Section (Optional Enhancement) -->
            <div
                *ngIf="
                    pageForm.get('title')?.value ||
                    pageForm.get('description')?.value
                "
                class="mt-8"
            >
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Preview</h3>
                        <p class="card-description">
                            This is how your page will appear to others
                        </p>
                    </div>
                    <div class="card-content">
                        <div class="space-y-4">
                            <div>
                                <h4
                                    class="text-xl font-semibold text-foreground"
                                >
                                    {{
                                        pageForm.get('title')?.value ||
                                            'Untitled Page'
                                    }}
                                </h4>
                                <p class="text-sm text-muted-foreground">
                                    Created by
                                    {{ getCurrentUserName() || 'You' }}
                                </p>
                            </div>
                            <div *ngIf="pageForm.get('description')?.value">
                                <p
                                    class="text-muted-foreground whitespace-pre-wrap"
                                >
                                    {{ pageForm.get('description')?.value }}
                                </p>
                            </div>
                            <div
                                *ngIf="!pageForm.get('description')?.value"
                                class="text-muted-foreground italic"
                            >
                                No description provided.
                            </div>

                            <!-- Preview Image -->
                            <div *ngIf="hasImageToDisplay()" class="mt-4">
                                <img
                                    [src]="getImageToDisplay()!"
                                    alt="Page image"
                                    class="w-full max-w-sm rounded-lg border border-border object-cover"
                                    style="max-height: 200px"
                                />
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</app-page>
